{"version":3,"file":"_server-39aa9ab0.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/(logged-in)/api/v1/files/download/_server.js"],"sourcesContent":["import { e as error } from \"../../../../../../../chunks/index.js\";\nimport { F as FILE_UPLOAD_DIR } from \"../../../../../../../chunks/env.js\";\nimport fs from \"node:fs/promises\";\nimport path from \"node:path\";\nimport { p as prisma } from \"../../../../../../../chunks/index4.js\";\nimport { zip } from \"fflate\";\nasync function GET({ locals, url }) {\n  const query = url.searchParams.getAll(\"id\");\n  if (query.length < 1)\n    throw error(400);\n  const coverslips = await prisma.coverslipFile.findMany({\n    where: {\n      id: {\n        in: query\n      },\n      createdByUserId: locals.user.id\n    }\n  });\n  if (coverslips.length < query.length)\n    throw error(404);\n  const fileBuffers = await Promise.all(coverslips.map((file) => {\n    const filepath = path.join(FILE_UPLOAD_DIR, file.id);\n    return fs.readFile(filepath);\n  }));\n  if (fileBuffers.length === 1)\n    return new Response(fileBuffers[0]);\n  const zipped = await new Promise((resolve) => {\n    const zippables = {};\n    for (let i = 0; i < fileBuffers.length; i++) {\n      zippables[coverslips[i].name] = fileBuffers[i];\n    }\n    zip(zippables, (_, result) => {\n      resolve(result);\n    });\n  });\n  return new Response(zipped);\n}\nexport {\n  GET\n};\n"],"names":["path"],"mappings":";;;;;;;;AAMA,eAAe,GAAG,CAAC,EAAE,MAAM,EAAE,GAAG,EAAE,EAAE;AACpC,EAAE,MAAM,KAAK,GAAG,GAAG,CAAC,YAAY,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AAC9C,EAAE,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC;AACtB,IAAI,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC;AACrB,EAAE,MAAM,UAAU,GAAG,MAAM,MAAM,CAAC,aAAa,CAAC,QAAQ,CAAC;AACzD,IAAI,KAAK,EAAE;AACX,MAAM,EAAE,EAAE;AACV,QAAQ,EAAE,EAAE,KAAK;AACjB,OAAO;AACP,MAAM,eAAe,EAAE,MAAM,CAAC,IAAI,CAAC,EAAE;AACrC,KAAK;AACL,GAAG,CAAC,CAAC;AACL,EAAE,IAAI,UAAU,CAAC,MAAM,GAAG,KAAK,CAAC,MAAM;AACtC,IAAI,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC;AACrB,EAAE,MAAM,WAAW,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,IAAI,KAAK;AACjE,IAAI,MAAM,QAAQ,GAAGA,MAAI,CAAC,IAAI,CAAC,eAAe,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC;AACzD,IAAI,OAAO,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;AACjC,GAAG,CAAC,CAAC,CAAC;AACN,EAAE,IAAI,WAAW,CAAC,MAAM,KAAK,CAAC;AAC9B,IAAI,OAAO,IAAI,QAAQ,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;AACxC,EAAE,MAAM,MAAM,GAAG,MAAM,IAAI,OAAO,CAAC,CAAC,OAAO,KAAK;AAChD,IAAI,MAAM,SAAS,GAAG,EAAE,CAAC;AACzB,IAAI,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,WAAW,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AACjD,MAAM,SAAS,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC;AACrD,KAAK;AACL,IAAI,GAAG,CAAC,SAAS,EAAE,CAAC,CAAC,EAAE,MAAM,KAAK;AAClC,MAAM,OAAO,CAAC,MAAM,CAAC,CAAC;AACtB,KAAK,CAAC,CAAC;AACP,GAAG,CAAC,CAAC;AACL,EAAE,OAAO,IAAI,QAAQ,CAAC,MAAM,CAAC,CAAC;AAC9B;;;;"}