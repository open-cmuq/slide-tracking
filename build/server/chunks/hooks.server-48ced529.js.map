{"version":3,"file":"hooks.server-48ced529.js","sources":["../../../.svelte-kit/adapter-node/chunks/hooks.server.js"],"sourcesContent":["import { config } from \"dotenv\";\nimport Google from \"@auth/core/providers/google\";\nimport { f as fail, j as json } from \"./index.js\";\nimport { nanoid } from \"nanoid\";\nimport { j as newUserSchema } from \"./forms.js\";\nimport { p as prisma } from \"./index4.js\";\nimport { D as DEV } from \"./prod-ssr.js\";\nimport { d as private_env } from \"./internal.js\";\nimport { Auth } from \"@auth/core\";\nconst dev = DEV;\nfunction sequence(...handlers) {\n  const length = handlers.length;\n  if (!length)\n    return ({ event, resolve }) => resolve(event);\n  return ({ event, resolve }) => {\n    return apply_handle(0, event, {});\n    function apply_handle(i, event2, parent_options) {\n      const handle2 = handlers[i];\n      return handle2({\n        event: event2,\n        resolve: (event3, options) => {\n          const transformPageChunk = async ({ html, done }) => {\n            if (options?.transformPageChunk) {\n              html = await options.transformPageChunk({ html, done }) ?? \"\";\n            }\n            if (parent_options?.transformPageChunk) {\n              html = await parent_options.transformPageChunk({ html, done }) ?? \"\";\n            }\n            return html;\n          };\n          return i < length - 1 ? apply_handle(i + 1, event3, { transformPageChunk }) : resolve(event3, { transformPageChunk });\n        }\n      });\n    }\n  };\n}\nasync function getSession(req, config2) {\n  config2.secret ??= private_env.AUTH_SECRET;\n  config2.trustHost ??= true;\n  const url = new URL(\"/api/auth/session\", req.url);\n  const request = new Request(url, { headers: req.headers });\n  const response = await Auth(request, config2);\n  const { status = 200 } = response;\n  const data = await response.json();\n  if (!data || !Object.keys(data).length)\n    return null;\n  if (status === 200)\n    return data;\n  throw new Error(data.message);\n}\nconst actions = [\n  \"providers\",\n  \"session\",\n  \"csrf\",\n  \"signin\",\n  \"signout\",\n  \"callback\",\n  \"verify-request\",\n  \"error\"\n];\nfunction AuthHandle(prefix, authOptions) {\n  return function({ event, resolve }) {\n    const { url, request } = event;\n    event.locals.getSession ??= () => getSession(request, authOptions);\n    const action = url.pathname.slice(prefix.length + 1).split(\"/\")[0];\n    if (!actions.includes(action) || !url.pathname.startsWith(prefix + \"/\")) {\n      return resolve(event);\n    }\n    return Auth(request, authOptions);\n  };\n}\nfunction SvelteKitAuth(options) {\n  const { prefix = \"/auth\", ...authOptions } = options;\n  authOptions.secret ??= private_env.AUTH_SECRET;\n  authOptions.trustHost ??= !!(private_env.AUTH_TRUST_HOST ?? private_env.VERCEL ?? dev);\n  return AuthHandle(prefix, authOptions);\n}\nconfig();\nconst AUTHJS_SECRET = process.env.AUTHJS_SECRET;\nconst GOOGLE_AUTH_CLIENT_ID = process.env.GOOGLE_AUTH_CLIENT_ID;\nconst GOOGLE_AUTH_SECRET = process.env.GOOGLE_AUTH_SECRET;\nconst authenticate = SvelteKitAuth({\n  trustHost: true,\n  callbacks: {\n    async signIn({ user: { email, name } }) {\n      if (!email || !name)\n        return false;\n      const user = await prisma.user.findUnique({ where: { email } });\n      if (user)\n        return true;\n      const userParse = newUserSchema.safeParse({ email, name });\n      if (!userParse.success) {\n        return fail(400, userParse.error.formErrors);\n      }\n      await prisma.user.create({\n        data: {\n          ...userParse.data,\n          id: nanoid()\n        }\n      }).then((newUser) => {\n        console.log(\"User created\");\n      }).catch((error) => {\n        console.error(error);\n      });\n      return true;\n    }\n  },\n  providers: [\n    // @ts-ignore\n    Google({\n      clientId: GOOGLE_AUTH_CLIENT_ID,\n      clientSecret: GOOGLE_AUTH_SECRET\n    })\n  ],\n  secret: AUTHJS_SECRET\n});\nasync function loadUser({ event, resolve }) {\n  const session = await event.locals.getSession();\n  if (!session)\n    return resolve(event);\n  const user = await prisma.user.findUnique({\n    where: {\n      email: (\n        /** @type {string} */\n        session.user?.email\n      )\n    }\n  });\n  if (user) {\n    event.locals.user = user;\n    event.locals.session = session;\n  }\n  return resolve(event);\n}\nfunction guardLogin({ event, resolve }) {\n  if (event.route.id?.startsWith(\"/(logged-in)\")) {\n    if (!event.locals.user) {\n      const { url: { protocol, host } } = event;\n      const root = new URL(`${protocol}//${host}/`);\n      return Response.redirect(root);\n    }\n  }\n  return resolve(event);\n}\nasync function redirect({ event, resolve }) {\n  const response = await resolve(event);\n  const dest = event.url.searchParams.get(\"redirect\");\n  if (dest) {\n    const isActionJsonRequest = response.headers.get(\"content-type\") === \"application/json\" && event.request.method === \"POST\";\n    console.log(dest);\n    const url = new URL(decodeURIComponent(dest), \"https://slide-tracking.qatar.cmu.edu\");\n    const knownRoutes = [\"/api\", \"/coverslip\", \"/experiment\", \"/experiments\", \"/project\", \"/projects\", \"/slide\", \"/slides\", \"/table\"];\n    if (knownRoutes.includes(url.pathname)) {\n      if (isActionJsonRequest) {\n        return json({\n          type: \"redirect\",\n          status: 302,\n          location: url.toString()\n        });\n      }\n      return Response.redirect(url.toString());\n    } else {\n      return isActionJsonRequest ? json({ error: \"Invalid redirect URL\" }) : Response.redirect(\"/error\");\n    }\n  }\n  return response;\n}\nconst handle = sequence(\n  authenticate,\n  loadUser,\n  guardLogin,\n  redirect\n);\nexport {\n  handle\n};\n"],"names":[],"mappings":"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"}